{
  "kind": "build_request",
  "title": "Implement minimal backend support for Pickup Point applications (create + admin list/approve/reject)",
  "priority": "normal",
  "requirements": [
    {
      "id": "REQ-20",
      "text": "Add backend canister methods in `backend/main.mo` to allow authenticated users to submit a Pickup Point application and persist it in the existing `pickupPointApplications : Map<Principal, PickupPointApplication>` state.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "ok so build these tiny steps"
        ]
      },
      "acceptanceCriteria": [
        "A new `shared ({ caller })` method exists to create a pickup point application and returns the created `PickupPointApplication`.",
        "The create method traps unless `caller` has `#user` permission via `AccessControl.hasPermission` (consistent with existing Personal Shopper methods).",
        "The create method traps if an application already exists for `caller` (prevents duplicate submissions).",
        "The created application is stored under `pickupPointApplications.add(caller, app)` with `status = #pending`, `submittedAt = Time.now()`, and `reviewedBy = null`.",
        "The application supports storing the uploaded business image using the existing `Storage.ExternalBlob` type (e.g., stored as a single-entry `kycDocs` array or equivalent without changing the public `PickupPointApplication` type)."
      ]
    },
    {
      "id": "REQ-21",
      "text": "Add backend admin query methods in `backend/main.mo` to list pending Pickup Point applications for review.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "ok so build these tiny steps"
        ]
      },
      "acceptanceCriteria": [
        "A new `query ({ caller })` method exists to list pending pickup point applications and returns `[PickupPointApplication]`.",
        "The list method traps unless `caller` has `#admin` permission.",
        "The list method returns only applications whose `status` is `#pending`."
      ]
    },
    {
      "id": "REQ-22",
      "text": "Add backend admin mutation methods in `backend/main.mo` to approve or reject a specific Pickup Point application by applicant principal, updating application status and related pickup point approval state.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "ok so build these tiny steps"
        ]
      },
      "acceptanceCriteria": [
        "A new `shared ({ caller })` method exists to approve a pickup point application by applicant `Principal`.",
        "A new `shared ({ caller })` method exists to reject a pickup point application by applicant `Principal` and a rejection `reason : Text`.",
        "Both methods trap unless `caller` has `#admin` permission.",
        "Both methods trap if the target application does not exist.",
        "Approve sets application `status = #approved` and `reviewedBy = ?caller` (and updates `submittedAt` is not modified).",
        "Reject sets application `status = #rejected(reason)` and `reviewedBy = ?caller`.",
        "Approving assigns a pickup point id using the existing `nextPickupPointId` counter and records the approved relationship in `approvedPickupPoints : Map<Nat, Principal>` (e.g., `approvedPickupPoints.add(nextPickupPointId, applicant)` then increments `nextPickupPointId`).",
        "Re-approving an already-approved application and re-rejecting an already-rejected application are handled deterministically (either trap with a clear error or no-op), without corrupting stored state."
      ]
    }
  ],
  "constraints": [
    "Backend must remain a single-actor Motoko canister; implement all logic in `backend/main.mo`.",
    "Do not modify files under `frontend/src/components/ui` or other frontend immutable paths listed in SYSTEM_CONTEXT.",
    "Keep this build step backend-only (no frontend routes/pages/hooks changes).",
    "Use English for any user-facing text (including trap messages)."
  ],
  "nonGoals": [
    "Implementing the Pickup Point signup UI flow (Join Us button enabling, form page, image upload UI).",
    "Implementing an admin Pickup Points page (`frontend/src/pages/admin/AdminPickupPointsPage.tsx`) or wiring frontend hooks to these methods.",
    "Implementing driver application backend/frontend changes.",
    "Implementing shopper changes (already handled separately)."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  },
  "userProfileUpdate": {
    "goalsToAdd": [],
    "goalsToRemove": [],
    "preferencesToAdd": [],
    "preferencesToRemove": [],
    "miscToAdd": [],
    "miscToRemove": [],
    "fieldsToSet": {},
    "fieldsToDelete": []
  }
}